(use judge)
(use /src/arcdown)

(def test-arcdown (slurp "./test/arc.arcd"))

(def test-sub-peg
  ~{:number (/ (<- :d) ,|[$ :sub-number])
    :symbol (/ (<- (set "#$%")) ,|[$ :sub-symbol])
    :main (some (+ :number :symbol))})

(def test-outer-peg
  ~{:sub-peg ,test-sub-peg
    :letter (/ (<- :w) ,|[$ :outer-letter])
    :main (some (+ :sub-peg :letter))})

(deftest "nested pegs work"
  (test (peg/match test-outer-peg "123$ab")
    @[["1" :sub-number]
      ["2" :sub-number]
      ["3" :sub-number]
      ["$" :sub-symbol]
      ["a" :outer-letter]
      ["b" :outer-letter]]))

(deftest "front-matter-peg: parses basic front matter"
  (test (first (peg/match front-matter-peg "---\nhellothere: a thing\n thisis: another thing\n---\n"))
    {:front-matter @{"hellothere" "a thing"
                     "thisis" "another thing"}}))

(deftest "md-table-peg: md-table.txt" 
  (def test-text (slurp "./test/md-table.txt"))
  (test (peg/match md-table-peg test-text)
    @[@["ESV" "NIV"]
      @["Thing" "Other Thing"]
      @["A" "Nothing"]]))

(deftest "md-table-peg: arctable.txt"
  (def test-text (slurp "./test/arctable.txt"))
  (test (peg/match md-table-peg test-text)
    @[@["Row" "ESV" "NIV" "NA28"]
      @["1"
        "13 I write these things to you who believe in the name of the Son of God,"
        "13 I write these things to you who believe in the name of the Son of God"
        "13 \xCE\xA4\xCE\xB1\xE1\xBF\xA6\xCF\x84\xCE\xB1 \xE1\xBC\x94\xCE\xB3\xCF\x81\xCE\xB1\xCF\x88\xCE\xB1 \xE1\xBD\x91\xCE\xBC\xE1\xBF\x96\xCE\xBD, [...] \xCF\x84\xCE\xBF\xE1\xBF\x96\xCF\x82 \xCF\x80\xCE\xB9\xCF\x83\xCF\x84\xCE\xB5\xCF\x8D\xCE\xBF\xCF\x85\xCF\x83\xCE\xB9\xCE\xBD \xCE\xB5\xE1\xBC\xB0\xCF\x82 \xCF\x84\xE1\xBD\xB8 \xE1\xBD\x84\xCE\xBD\xCE\xBF\xCE\xBC\xCE\xB1 \xCF\x84\xCE\xBF\xE1\xBF\xA6 \xCF\x85\xE1\xBC\xB1\xCE\xBF\xE1\xBF\xA6 \xCF\x84\xCE\xBF\xE1\xBF\xA6 \xCE\xB8\xCE\xB5\xCE\xBF\xE1\xBF\xA6."]
      @["2"
        "that you may know"
        "so that you may know"
        "... \xE1\xBC\xB5\xCE\xBD\xCE\xB1 \xCE\xB5\xE1\xBC\xB0\xCE\xB4\xE1\xBF\x86\xCF\x84\xCE\xB5 [...] ..."]
      @["3"
        "that you have eternal life."
        "that you have eternal life."
        "... \xE1\xBD\x85\xCF\x84\xCE\xB9 \xCE\xB6\xCF\x89\xE1\xBD\xB4\xCE\xBD \xE1\xBC\x94\xCF\x87\xCE\xB5\xCF\x84\xCE\xB5 \xCE\xB1\xE1\xBC\xB0\xCF\x8E\xCE\xBD\xCE\xB9\xCE\xBF\xCE\xBD, ..."]
      @["4"
        "14 And this is the confidence that we have toward him,"
        "14 This is the confidence we have in approaching God:"
        "14 \xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xCE\xB1\xE1\xBD\x95\xCF\x84\xCE\xB7 \xE1\xBC\x90\xCF\x83\xCF\x84\xE1\xBD\xB6\xCE\xBD \xE1\xBC\xA1 \xCF\x80\xCE\xB1\xCF\x81\xCF\x81\xCE\xB7\xCF\x83\xCE\xAF\xCE\xB1 \xE1\xBC\xA3\xCE\xBD \xE1\xBC\x94\xCF\x87\xCE\xBF\xCE\xBC\xCE\xB5\xCE\xBD \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB1\xE1\xBD\x90\xCF\x84\xCF\x8C\xCE\xBD,"]
      @["5"
        "that if we ask anything according to his will"
        "that if we ask anything according to his will,"
        "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x90\xCE\xAC\xCE\xBD \xCF\x84\xCE\xB9 \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCF\x8E\xCE\xBC\xCE\xB5\xCE\xB8\xCE\xB1 \xCE\xBA\xCE\xB1\xCF\x84\xE1\xBD\xB0 \xCF\x84\xE1\xBD\xB8 \xCE\xB8\xCE\xAD\xCE\xBB\xCE\xB7\xCE\xBC\xCE\xB1 \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6"]
      @["6"
        "he hears us."
        "he hears us."
        "\xE1\xBC\x80\xCE\xBA\xCE\xBF\xCF\x8D\xCE\xB5\xCE\xB9 \xE1\xBC\xA1\xCE\xBC\xE1\xBF\xB6\xCE\xBD."]
      @["7"
        "15 And if we know"
        "15 And if we know"
        "15 \xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xE1\xBC\x90\xE1\xBD\xB0\xCE\xBD \xCE\xBF\xE1\xBC\xB4\xCE\xB4\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD"]
      @["8"
        "that he hears us in whatever we ask,"
        "that he hears us\xE2\x80\x94whatever we ask\xE2\x80\x94"
        "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x80\xCE\xBA\xCE\xBF\xCF\x8D\xCE\xB5\xCE\xB9 \xE1\xBC\xA1\xCE\xBC\xE1\xBF\xB6\xCE\xBD \xE1\xBD\x83 \xE1\xBC\x90\xE1\xBD\xB0\xCE\xBD \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCF\x8E\xCE\xBC\xCE\xB5\xCE\xB8\xCE\xB1,"]
      @["9"
        "we know"
        "we know"
        "\xCE\xBF\xE1\xBC\xB4\xCE\xB4\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD"]
      @["10"
        "that we have the requests that we have asked of him."
        "that we have what we asked of him."
        "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x94\xCF\x87\xCE\xBF\xCE\xBC\xCE\xB5\xCE\xBD \xCF\x84\xE1\xBD\xB0 \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCE\xAE\xCE\xBC\xCE\xB1\xCF\x84\xCE\xB1 \xE1\xBC\x83 \xE1\xBE\x90\xCF\x84\xCE\xAE\xCE\xBA\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD \xE1\xBC\x80\xCF\x80\xCA\xBC \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6."]
      @["11"
        "16 If anyone sees his brother committing a sin"
        "16 If you see any brother or sister commit a sin"
        "16 \xE1\xBC\x98\xCE\xAC\xCE\xBD \xCF\x84\xCE\xB9\xCF\x82 \xE1\xBC\xB4\xCE\xB4\xE1\xBF\x83 \xCF\x84\xE1\xBD\xB8\xCE\xBD \xE1\xBC\x80\xCE\xB4\xCE\xB5\xCE\xBB\xCF\x86\xE1\xBD\xB8\xCE\xBD \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAC\xCE\xBD\xCE\xBF\xCE\xBD\xCF\x84\xCE\xB1 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1\xCE\xBD"]
      @["12"
        "not leading to death,"
        "that does not lead to death,"
        "\xCE\xBC\xE1\xBD\xB4 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD,"]
      @["13"
        "he shall ask,"
        "you should pray"
        "\xCE\xB1\xE1\xBC\xB0\xCF\x84\xCE\xAE\xCF\x83\xCE\xB5\xCE\xB9"]
      @["14"
        "and God will give him life\xE2\x80\x94"
        "and God will give them life."
        "\xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xCE\xB4\xCF\x8E\xCF\x83\xCE\xB5\xCE\xB9 \xCE\xB1\xE1\xBD\x90\xCF\x84\xE1\xBF\xB7 \xCE\xB6\xCF\x89\xCE\xAE\xCE\xBD,"]
      @["15"
        "to those who commit sins that do not lead to death."
        "I refer to those whose sin does not lead to death."
        "\xCF\x84\xCE\xBF\xE1\xBF\x96\xCF\x82 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAC\xCE\xBD\xCE\xBF\xCF\x85\xCF\x83\xCE\xB9\xCE\xBD \xCE\xBC\xE1\xBD\xB4 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD."]
      @["16"
        "There is sin that leads to death;"
        "There is a sin that leads to death."
        "\xE1\xBC\x94\xCF\x83\xCF\x84\xCE\xB9\xCE\xBD \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD\xC2\xB7"]
      @["17"
        "I do not say that one should pray for that."
        "I am not saying that you should pray about that."
        "\xCE\xBF\xE1\xBD\x90 \xCF\x80\xCE\xB5\xCF\x81\xE1\xBD\xB6 \xE1\xBC\x90\xCE\xBA\xCE\xB5\xCE\xAF\xCE\xBD\xCE\xB7\xCF\x82 \xCE\xBB\xCE\xAD\xCE\xB3\xCF\x89 \xE1\xBC\xB5\xCE\xBD\xCE\xB1 \xE1\xBC\x90\xCF\x81\xCF\x89\xCF\x84\xCE\xAE\xCF\x83\xE1\xBF\x83."]
      @["18"
        "17 All wrongdoing is sin,"
        "17 All wrongdoing is sin,"
        "17 \xCF\x80\xE1\xBE\xB6\xCF\x83\xCE\xB1 \xE1\xBC\x80\xCE\xB4\xCE\xB9\xCE\xBA\xCE\xAF\xCE\xB1 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xE1\xBC\x90\xCF\x83\xCF\x84\xCE\xAF\xCE\xBD,"]
      @["19"
        "but there is sin that does not lead to death."
        "and there is sin that does not lead to death."
        "\xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xE1\xBC\x94\xCF\x83\xCF\x84\xCE\xB9\xCE\xBD \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xCE\xBF\xE1\xBD\x90 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD."]]))

(deftest "arc-text-peg: parse arctext.txt"
  (def test-text (slurp "./test/arctext.txt"))
  (test (peg/match arc-text-peg test-text)
    @[{:arc-text @[@["Row" "ESV" "NIV" "NA28"]
                   @["1"
                     "13 I write these things to you who believe in the name of the Son of God,"
                     "13 I write these things to you who believe in the name of the Son of God"
                     "13 \xCE\xA4\xCE\xB1\xE1\xBF\xA6\xCF\x84\xCE\xB1 \xE1\xBC\x94\xCE\xB3\xCF\x81\xCE\xB1\xCF\x88\xCE\xB1 \xE1\xBD\x91\xCE\xBC\xE1\xBF\x96\xCE\xBD, [...] \xCF\x84\xCE\xBF\xE1\xBF\x96\xCF\x82 \xCF\x80\xCE\xB9\xCF\x83\xCF\x84\xCE\xB5\xCF\x8D\xCE\xBF\xCF\x85\xCF\x83\xCE\xB9\xCE\xBD \xCE\xB5\xE1\xBC\xB0\xCF\x82 \xCF\x84\xE1\xBD\xB8 \xE1\xBD\x84\xCE\xBD\xCE\xBF\xCE\xBC\xCE\xB1 \xCF\x84\xCE\xBF\xE1\xBF\xA6 \xCF\x85\xE1\xBC\xB1\xCE\xBF\xE1\xBF\xA6 \xCF\x84\xCE\xBF\xE1\xBF\xA6 \xCE\xB8\xCE\xB5\xCE\xBF\xE1\xBF\xA6."]
                   @["2"
                     "that you may know"
                     "so that you may know"
                     "... \xE1\xBC\xB5\xCE\xBD\xCE\xB1 \xCE\xB5\xE1\xBC\xB0\xCE\xB4\xE1\xBF\x86\xCF\x84\xCE\xB5 [...] ..."]
                   @["3"
                     "that you have eternal life."
                     "that you have eternal life."
                     "... \xE1\xBD\x85\xCF\x84\xCE\xB9 \xCE\xB6\xCF\x89\xE1\xBD\xB4\xCE\xBD \xE1\xBC\x94\xCF\x87\xCE\xB5\xCF\x84\xCE\xB5 \xCE\xB1\xE1\xBC\xB0\xCF\x8E\xCE\xBD\xCE\xB9\xCE\xBF\xCE\xBD, ..."]
                   @["4"
                     "14 And this is the confidence that we have toward him,"
                     "14 This is the confidence we have in approaching God:"
                     "14 \xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xCE\xB1\xE1\xBD\x95\xCF\x84\xCE\xB7 \xE1\xBC\x90\xCF\x83\xCF\x84\xE1\xBD\xB6\xCE\xBD \xE1\xBC\xA1 \xCF\x80\xCE\xB1\xCF\x81\xCF\x81\xCE\xB7\xCF\x83\xCE\xAF\xCE\xB1 \xE1\xBC\xA3\xCE\xBD \xE1\xBC\x94\xCF\x87\xCE\xBF\xCE\xBC\xCE\xB5\xCE\xBD \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB1\xE1\xBD\x90\xCF\x84\xCF\x8C\xCE\xBD,"]
                   @["5"
                     "that if we ask anything according to his will"
                     "that if we ask anything according to his will,"
                     "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x90\xCE\xAC\xCE\xBD \xCF\x84\xCE\xB9 \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCF\x8E\xCE\xBC\xCE\xB5\xCE\xB8\xCE\xB1 \xCE\xBA\xCE\xB1\xCF\x84\xE1\xBD\xB0 \xCF\x84\xE1\xBD\xB8 \xCE\xB8\xCE\xAD\xCE\xBB\xCE\xB7\xCE\xBC\xCE\xB1 \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6"]
                   @["6"
                     "he hears us."
                     "he hears us."
                     "\xE1\xBC\x80\xCE\xBA\xCE\xBF\xCF\x8D\xCE\xB5\xCE\xB9 \xE1\xBC\xA1\xCE\xBC\xE1\xBF\xB6\xCE\xBD."]
                   @["7"
                     "15 And if we know"
                     "15 And if we know"
                     "15 \xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xE1\xBC\x90\xE1\xBD\xB0\xCE\xBD \xCE\xBF\xE1\xBC\xB4\xCE\xB4\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD"]
                   @["8"
                     "that he hears us in whatever we ask,"
                     "that he hears us\xE2\x80\x94whatever we ask\xE2\x80\x94"
                     "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x80\xCE\xBA\xCE\xBF\xCF\x8D\xCE\xB5\xCE\xB9 \xE1\xBC\xA1\xCE\xBC\xE1\xBF\xB6\xCE\xBD \xE1\xBD\x83 \xE1\xBC\x90\xE1\xBD\xB0\xCE\xBD \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCF\x8E\xCE\xBC\xCE\xB5\xCE\xB8\xCE\xB1,"]
                   @["9"
                     "we know"
                     "we know"
                     "\xCE\xBF\xE1\xBC\xB4\xCE\xB4\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD"]
                   @["10"
                     "that we have the requests that we have asked of him."
                     "that we have what we asked of him."
                     "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x94\xCF\x87\xCE\xBF\xCE\xBC\xCE\xB5\xCE\xBD \xCF\x84\xE1\xBD\xB0 \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCE\xAE\xCE\xBC\xCE\xB1\xCF\x84\xCE\xB1 \xE1\xBC\x83 \xE1\xBE\x90\xCF\x84\xCE\xAE\xCE\xBA\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD \xE1\xBC\x80\xCF\x80\xCA\xBC \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6."]
                   @["11"
                     "16 If anyone sees his brother committing a sin"
                     "16 If you see any brother or sister commit a sin"
                     "16 \xE1\xBC\x98\xCE\xAC\xCE\xBD \xCF\x84\xCE\xB9\xCF\x82 \xE1\xBC\xB4\xCE\xB4\xE1\xBF\x83 \xCF\x84\xE1\xBD\xB8\xCE\xBD \xE1\xBC\x80\xCE\xB4\xCE\xB5\xCE\xBB\xCF\x86\xE1\xBD\xB8\xCE\xBD \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAC\xCE\xBD\xCE\xBF\xCE\xBD\xCF\x84\xCE\xB1 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1\xCE\xBD"]
                   @["12"
                     "not leading to death,"
                     "that does not lead to death,"
                     "\xCE\xBC\xE1\xBD\xB4 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD,"]
                   @["13"
                     "he shall ask,"
                     "you should pray"
                     "\xCE\xB1\xE1\xBC\xB0\xCF\x84\xCE\xAE\xCF\x83\xCE\xB5\xCE\xB9"]
                   @["14"
                     "and God will give him life\xE2\x80\x94"
                     "and God will give them life."
                     "\xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xCE\xB4\xCF\x8E\xCF\x83\xCE\xB5\xCE\xB9 \xCE\xB1\xE1\xBD\x90\xCF\x84\xE1\xBF\xB7 \xCE\xB6\xCF\x89\xCE\xAE\xCE\xBD,"]
                   @["15"
                     "to those who commit sins that do not lead to death."
                     "I refer to those whose sin does not lead to death."
                     "\xCF\x84\xCE\xBF\xE1\xBF\x96\xCF\x82 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAC\xCE\xBD\xCE\xBF\xCF\x85\xCF\x83\xCE\xB9\xCE\xBD \xCE\xBC\xE1\xBD\xB4 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD."]
                   @["16"
                     "There is sin that leads to death;"
                     "There is a sin that leads to death."
                     "\xE1\xBC\x94\xCF\x83\xCF\x84\xCE\xB9\xCE\xBD \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD\xC2\xB7"]
                   @["17"
                     "I do not say that one should pray for that."
                     "I am not saying that you should pray about that."
                     "\xCE\xBF\xE1\xBD\x90 \xCF\x80\xCE\xB5\xCF\x81\xE1\xBD\xB6 \xE1\xBC\x90\xCE\xBA\xCE\xB5\xCE\xAF\xCE\xBD\xCE\xB7\xCF\x82 \xCE\xBB\xCE\xAD\xCE\xB3\xCF\x89 \xE1\xBC\xB5\xCE\xBD\xCE\xB1 \xE1\xBC\x90\xCF\x81\xCF\x89\xCF\x84\xCE\xAE\xCF\x83\xE1\xBF\x83."]
                   @["18"
                     "17 All wrongdoing is sin,"
                     "17 All wrongdoing is sin,"
                     "17 \xCF\x80\xE1\xBE\xB6\xCF\x83\xCE\xB1 \xE1\xBC\x80\xCE\xB4\xCE\xB9\xCE\xBA\xCE\xAF\xCE\xB1 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xE1\xBC\x90\xCF\x83\xCF\x84\xCE\xAF\xCE\xBD,"]
                   @["19"
                     "but there is sin that does not lead to death."
                     "and there is sin that does not lead to death."
                     "\xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xE1\xBC\x94\xCF\x83\xCF\x84\xCE\xB9\xCE\xBD \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xCE\xBF\xE1\xBD\x90 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD."]]}]))

(deftest "arc-down-peg: parse real `.arcd` file"
  (test (peg/match arcdown-peg test-arcdown)
    @[{:front-matter @{"passage" "1 John 5:13-17"}}
      {:arc-text @[@["Row" "ESV" "NIV" "NA28"]
                   @["1"
                     "13 I write these things to you who believe in the name of the Son of God,"
                     "13 I write these things to you who believe in the name of the Son of God"
                     "13 \xCE\xA4\xCE\xB1\xE1\xBF\xA6\xCF\x84\xCE\xB1 \xE1\xBC\x94\xCE\xB3\xCF\x81\xCE\xB1\xCF\x88\xCE\xB1 \xE1\xBD\x91\xCE\xBC\xE1\xBF\x96\xCE\xBD, [...] \xCF\x84\xCE\xBF\xE1\xBF\x96\xCF\x82 \xCF\x80\xCE\xB9\xCF\x83\xCF\x84\xCE\xB5\xCF\x8D\xCE\xBF\xCF\x85\xCF\x83\xCE\xB9\xCE\xBD \xCE\xB5\xE1\xBC\xB0\xCF\x82 \xCF\x84\xE1\xBD\xB8 \xE1\xBD\x84\xCE\xBD\xCE\xBF\xCE\xBC\xCE\xB1 \xCF\x84\xCE\xBF\xE1\xBF\xA6 \xCF\x85\xE1\xBC\xB1\xCE\xBF\xE1\xBF\xA6 \xCF\x84\xCE\xBF\xE1\xBF\xA6 \xCE\xB8\xCE\xB5\xCE\xBF\xE1\xBF\xA6."]
                   @["2"
                     "that you may know"
                     "so that you may know"
                     "... \xE1\xBC\xB5\xCE\xBD\xCE\xB1 \xCE\xB5\xE1\xBC\xB0\xCE\xB4\xE1\xBF\x86\xCF\x84\xCE\xB5 [...] ..."]
                   @["3"
                     "that you have eternal life."
                     "that you have eternal life."
                     "... \xE1\xBD\x85\xCF\x84\xCE\xB9 \xCE\xB6\xCF\x89\xE1\xBD\xB4\xCE\xBD \xE1\xBC\x94\xCF\x87\xCE\xB5\xCF\x84\xCE\xB5 \xCE\xB1\xE1\xBC\xB0\xCF\x8E\xCE\xBD\xCE\xB9\xCE\xBF\xCE\xBD, ..."]
                   @["4"
                     "14 And this is the confidence that we have toward him,"
                     "14 This is the confidence we have in approaching God:"
                     "14 \xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xCE\xB1\xE1\xBD\x95\xCF\x84\xCE\xB7 \xE1\xBC\x90\xCF\x83\xCF\x84\xE1\xBD\xB6\xCE\xBD \xE1\xBC\xA1 \xCF\x80\xCE\xB1\xCF\x81\xCF\x81\xCE\xB7\xCF\x83\xCE\xAF\xCE\xB1 \xE1\xBC\xA3\xCE\xBD \xE1\xBC\x94\xCF\x87\xCE\xBF\xCE\xBC\xCE\xB5\xCE\xBD \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB1\xE1\xBD\x90\xCF\x84\xCF\x8C\xCE\xBD,"]
                   @["5"
                     "that if we ask anything according to his will"
                     "that if we ask anything according to his will,"
                     "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x90\xCE\xAC\xCE\xBD \xCF\x84\xCE\xB9 \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCF\x8E\xCE\xBC\xCE\xB5\xCE\xB8\xCE\xB1 \xCE\xBA\xCE\xB1\xCF\x84\xE1\xBD\xB0 \xCF\x84\xE1\xBD\xB8 \xCE\xB8\xCE\xAD\xCE\xBB\xCE\xB7\xCE\xBC\xCE\xB1 \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6"]
                   @["6"
                     "he hears us."
                     "he hears us."
                     "\xE1\xBC\x80\xCE\xBA\xCE\xBF\xCF\x8D\xCE\xB5\xCE\xB9 \xE1\xBC\xA1\xCE\xBC\xE1\xBF\xB6\xCE\xBD."]
                   @["7"
                     "15 And if we know"
                     "15 And if we know"
                     "15 \xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xE1\xBC\x90\xE1\xBD\xB0\xCE\xBD \xCE\xBF\xE1\xBC\xB4\xCE\xB4\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD"]
                   @["8"
                     "that he hears us in whatever we ask,"
                     "that he hears us\xE2\x80\x94whatever we ask\xE2\x80\x94"
                     "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x80\xCE\xBA\xCE\xBF\xCF\x8D\xCE\xB5\xCE\xB9 \xE1\xBC\xA1\xCE\xBC\xE1\xBF\xB6\xCE\xBD \xE1\xBD\x83 \xE1\xBC\x90\xE1\xBD\xB0\xCE\xBD \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCF\x8E\xCE\xBC\xCE\xB5\xCE\xB8\xCE\xB1,"]
                   @["9"
                     "we know"
                     "we know"
                     "\xCE\xBF\xE1\xBC\xB4\xCE\xB4\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD"]
                   @["10"
                     "that we have the requests that we have asked of him."
                     "that we have what we asked of him."
                     "\xE1\xBD\x85\xCF\x84\xCE\xB9 \xE1\xBC\x94\xCF\x87\xCE\xBF\xCE\xBC\xCE\xB5\xCE\xBD \xCF\x84\xE1\xBD\xB0 \xCE\xB1\xE1\xBC\xB0\xCF\x84\xCE\xAE\xCE\xBC\xCE\xB1\xCF\x84\xCE\xB1 \xE1\xBC\x83 \xE1\xBE\x90\xCF\x84\xCE\xAE\xCE\xBA\xCE\xB1\xCE\xBC\xCE\xB5\xCE\xBD \xE1\xBC\x80\xCF\x80\xCA\xBC \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6."]
                   @["11"
                     "16 If anyone sees his brother committing a sin"
                     "16 If you see any brother or sister commit a sin"
                     "16 \xE1\xBC\x98\xCE\xAC\xCE\xBD \xCF\x84\xCE\xB9\xCF\x82 \xE1\xBC\xB4\xCE\xB4\xE1\xBF\x83 \xCF\x84\xE1\xBD\xB8\xCE\xBD \xE1\xBC\x80\xCE\xB4\xCE\xB5\xCE\xBB\xCF\x86\xE1\xBD\xB8\xCE\xBD \xCE\xB1\xE1\xBD\x90\xCF\x84\xCE\xBF\xE1\xBF\xA6 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAC\xCE\xBD\xCE\xBF\xCE\xBD\xCF\x84\xCE\xB1 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1\xCE\xBD"]
                   @["12"
                     "not leading to death,"
                     "that does not lead to death,"
                     "\xCE\xBC\xE1\xBD\xB4 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD,"]
                   @["13"
                     "he shall ask,"
                     "you should pray"
                     "\xCE\xB1\xE1\xBC\xB0\xCF\x84\xCE\xAE\xCF\x83\xCE\xB5\xCE\xB9"]
                   @["14"
                     "and God will give him life\xE2\x80\x94"
                     "and God will give them life."
                     "\xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xCE\xB4\xCF\x8E\xCF\x83\xCE\xB5\xCE\xB9 \xCE\xB1\xE1\xBD\x90\xCF\x84\xE1\xBF\xB7 \xCE\xB6\xCF\x89\xCE\xAE\xCE\xBD,"]
                   @["15"
                     "to those who commit sins that do not lead to death."
                     "I refer to those whose sin does not lead to death."
                     "\xCF\x84\xCE\xBF\xE1\xBF\x96\xCF\x82 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAC\xCE\xBD\xCE\xBF\xCF\x85\xCF\x83\xCE\xB9\xCE\xBD \xCE\xBC\xE1\xBD\xB4 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD."]
                   @["16"
                     "There is sin that leads to death;"
                     "There is a sin that leads to death."
                     "\xE1\xBC\x94\xCF\x83\xCF\x84\xCE\xB9\xCE\xBD \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD\xC2\xB7"]
                   @["17"
                     "I do not say that one should pray for that."
                     "I am not saying that you should pray about that."
                     "\xCE\xBF\xE1\xBD\x90 \xCF\x80\xCE\xB5\xCF\x81\xE1\xBD\xB6 \xE1\xBC\x90\xCE\xBA\xCE\xB5\xCE\xAF\xCE\xBD\xCE\xB7\xCF\x82 \xCE\xBB\xCE\xAD\xCE\xB3\xCF\x89 \xE1\xBC\xB5\xCE\xBD\xCE\xB1 \xE1\xBC\x90\xCF\x81\xCF\x89\xCF\x84\xCE\xAE\xCF\x83\xE1\xBF\x83."]
                   @["18"
                     "17 All wrongdoing is sin,"
                     "17 All wrongdoing is sin,"
                     "17 \xCF\x80\xE1\xBE\xB6\xCF\x83\xCE\xB1 \xE1\xBC\x80\xCE\xB4\xCE\xB9\xCE\xBA\xCE\xAF\xCE\xB1 \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xE1\xBC\x90\xCF\x83\xCF\x84\xCE\xAF\xCE\xBD,"]
                   @["19"
                     "but there is sin that does not lead to death."
                     "and there is sin that does not lead to death."
                     "\xCE\xBA\xCE\xB1\xE1\xBD\xB6 \xE1\xBC\x94\xCF\x83\xCF\x84\xCE\xB9\xCE\xBD \xE1\xBC\x81\xCE\xBC\xCE\xB1\xCF\x81\xCF\x84\xCE\xAF\xCE\xB1 \xCE\xBF\xE1\xBD\x90 \xCF\x80\xCF\x81\xE1\xBD\xB8\xCF\x82 \xCE\xB8\xCE\xAC\xCE\xBD\xCE\xB1\xCF\x84\xCE\xBF\xCE\xBD."]]}]))